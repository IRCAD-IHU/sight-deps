stages:
  - build
  - deploy

.linux_template: &linux_job
  image: "${SIGHT_CI_UBUNTU20_10}:dev"
  before_script:
    - mkdir -p $CI_PROJECT_DIR/install $CI_PROJECT_DIR/build
    - sudo chown -R sight:sight .
    # Merge the branch into dev.
    - >
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "dev" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        git config user.name ${GITLAB_USER_ID}
        git config user.email ${GITLAB_USER_EMAIL}
        git fetch --all
        git checkout dev
        git reset --hard origin/dev
        git merge "origin/"${CI_COMMIT_REF_NAME} --no-commit --no-ff
        export EXTRA_BRANCH="dev"
      else
        export EXTRA_BRANCH="${CI_COMMIT_REF_NAME}"
      fi

build:debug-linux:
  <<: *linux_job
  stage: build
  dependencies: []
  script:
    # Build the project on the merge result.
    - mkdir -p $CI_PROJECT_DIR/archive
    - rm -rf $CI_PROJECT_DIR/archive/* $CI_PROJECT_DIR/build/* $CI_PROJECT_DIR/install/*
    - cd $CI_PROJECT_DIR/build/
    - >
      cmake $CI_PROJECT_DIR
      -G Ninja
      -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/install
      -DCMAKE_BUILD_TYPE=Debug
    - ninja
    # Install and build the package
    - ninja install
    - ninja package
    # Retrieve package name and store it as environment files since inherited environment variable is experimental
    # and need to explicitly enabled (https://docs.gitlab.com/ee/ci/variables/#enable-inherited-environment-variables-core-only)
    - export DEBUG_ARCHIVE_FILE_PATH=$(find $CI_PROJECT_DIR/build -maxdepth 1 -iname '*.tar.zst' -type f -print -quit)
    - export DEBUG_ARCHIVE_NAME=$(basename -s .tar.zst ${DEBUG_ARCHIVE_FILE_PATH})
    - mv ${DEBUG_ARCHIVE_FILE_PATH} $CI_PROJECT_DIR/archive/debug_archive.tar.zst
    - echo "export DEBUG_ARCHIVE_NAME=${DEBUG_ARCHIVE_NAME}" > $CI_PROJECT_DIR/archive/DEBUG_ARCHIVE_NAME.env
    - cat $CI_PROJECT_DIR/archive/DEBUG_ARCHIVE_NAME.env
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SIGHTDEPS"
    paths:
      # We cannot use ${DEBUG_ARCHIVE_NAME} here
      - $CI_PROJECT_DIR/archive/DEBUG_ARCHIVE_NAME.env
      - $CI_PROJECT_DIR/archive/debug_archive.tar.zst
    when: always

build:release-linux:
  <<: *linux_job
  stage: build
  dependencies: []
  script:
    # Build the project on the merge result.
    - mkdir -p $CI_PROJECT_DIR/archive
    - rm -rf $CI_PROJECT_DIR/archive/* $CI_PROJECT_DIR/build/* $CI_PROJECT_DIR/install/*
    - cd $CI_PROJECT_DIR/build
    - >
      cmake $CI_PROJECT_DIR
      -G Ninja
      -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/install
      -DCMAKE_BUILD_TYPE=Release
    - ninja
    # Install and build the package
    - ninja install
    - ninja package
    # Retrieve package name and store it as environment files since inherited environment variable is experimental
    # and need to explicitly enabled (https://docs.gitlab.com/ee/ci/variables/#enable-inherited-environment-variables-core-only)
    - export RELEASE_ARCHIVE_FILE_PATH=$(find $CI_PROJECT_DIR/build -maxdepth 1 -iname '*.tar.zst' -type f -print -quit)
    - export RELEASE_ARCHIVE_NAME=$(basename -s .tar.zst ${RELEASE_ARCHIVE_FILE_PATH})
    - mv ${RELEASE_ARCHIVE_FILE_PATH} $CI_PROJECT_DIR/archive/release_archive.tar.zst
    - echo "export RELEASE_ARCHIVE_NAME=${RELEASE_ARCHIVE_NAME}" > $CI_PROJECT_DIR/archive/RELEASE_ARCHIVE_NAME.env
    - cat $CI_PROJECT_DIR/archive/RELEASE_ARCHIVE_NAME.env
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SIGHTDEPS"
    paths:
      # We cannot use ${RELEASE_ARCHIVE_NAME} here
      - $CI_PROJECT_DIR/archive/RELEASE_ARCHIVE_NAME.env
      - $CI_PROJECT_DIR/archive/release_archive.tar.zst
    when: always

build:relwithdebinfo-linux:
  <<: *linux_job
  stage: build
  dependencies: []
  script:
    # Build the project on the merge result.
    - mkdir -p $CI_PROJECT_DIR/archive
    - rm -rf $CI_PROJECT_DIR/archive/* $CI_PROJECT_DIR/build/* $CI_PROJECT_DIR/install/*
    - cd $CI_PROJECT_DIR/build/
    - >
      cmake $CI_PROJECT_DIR
      -G Ninja
      -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/install
      -DCMAKE_BUILD_TYPE=RelWithDebInfo
    - ninja
    # Install and build the package
    - ninja install
    - ninja package
    # Retrieve package name and store it as environment files since inherited environment variable is experimental
    # and need to explicitly enabled (https://docs.gitlab.com/ee/ci/variables/#enable-inherited-environment-variables-core-only)
    - export RELWITHDEBINFO_ARCHIVE_FILE_PATH=$(find $CI_PROJECT_DIR/build -maxdepth 1 -iname '*.tar.zst' -type f -print -quit)
    - export RELWITHDEBINFO_ARCHIVE_NAME=$(basename -s .tar.zst ${RELWITHDEBINFO_ARCHIVE_FILE_PATH})
    - mv ${RELWITHDEBINFO_ARCHIVE_FILE_PATH} $CI_PROJECT_DIR/archive/relwithdebinfo_archive.tar.zst
    - echo "export RELWITHDEBINFO_ARCHIVE_NAME=${RELWITHDEBINFO_ARCHIVE_NAME}" > $CI_PROJECT_DIR/archive/RELWITHDEBINFO_ARCHIVE_NAME.env
    - cat $CI_PROJECT_DIR/archive/RELWITHDEBINFO_ARCHIVE_NAME.env
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SIGHTDEPS"
    paths:
      # We cannot use ${RELWITHDEBINFO_ARCHIVE_NAME} here
      - $CI_PROJECT_DIR/archive/RELWITHDEBINFO_ARCHIVE_NAME.env
      - $CI_PROJECT_DIR/archive/relwithdebinfo_archive.tar.zst
    when: always

deploy:debug-linux:
  <<: *linux_job
  stage: deploy
  when: manual
  script:
    - source $CI_PROJECT_DIR/archive/DEBUG_ARCHIVE_NAME.env
    - >
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "dev" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/debug_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/${DEBUG_ARCHIVE_NAME}.tar.zst"
      else
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/debug_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/${DEBUG_ARCHIVE_NAME}-$CI_COMMIT_REF_NAME.tar.zst"
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/debug_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/sight-deps-debug-latest-Linux.tar.zst"
      fi
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SIGHTDEPS"
    paths:
      - $CI_PROJECT_DIR/archive/debug_archive.tar.zst

deploy:release-linux:
  <<: *linux_job
  stage: deploy
  when: manual
  script:
    - source $CI_PROJECT_DIR/archive/RELEASE_ARCHIVE_NAME.env
    - >
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "dev" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/release_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/${RELEASE_ARCHIVE_NAME}.tar.zst"
      else
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/release_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/${RELEASE_ARCHIVE_NAME}-$CI_COMMIT_REF_NAME.tar.zst"
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/release_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/sight-deps-release-latest-Linux.tar.zst"
      fi
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SIGHTDEPS"
    paths:
      - $CI_PROJECT_DIR/archive/release_archive.tar.zst

deploy:relwithdebinfo-linux:
  <<: *linux_job
  stage: deploy
  when: manual
  script:
    - source $CI_PROJECT_DIR/archive/RELWITHDEBINFO_ARCHIVE_NAME.env
    - >
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "dev" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/relwithdebinfo_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/${RELWITHDEBINFO_ARCHIVE_NAME}.tar.zst"
      else
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/relwithdebinfo_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/${RELWITHDEBINFO_ARCHIVE_NAME}-$CI_COMMIT_REF_NAME.tar.zst"
        curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/relwithdebinfo_archive.tar.zst "https://conan.ircad.fr/artifactory/data/sight-deps/sight-deps-relwithdebinfo-latest-Linux.tar.zst"
      fi
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SIGHTDEPS"
    paths:
      - $CI_PROJECT_DIR/archive/relwithdebinfo_archive.tar.zst
