stages:
  - build
  - deploy

.linux_template: &linux_job
  image: "${SIGHT_CI_UBUNTU20_10}:dev"
  before_script:
    - mkdir -p $CI_PROJECT_DIR/install $CI_PROJECT_DIR/build
    - sudo chown -R sight:sight .
    # Reset the time of all files to improve the use of ccache.
    - /usr/lib/git-core/git-restore-mtime --force --skip-missing --commit-time
    # Merge the branch into dev.
    - >
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "dev" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        git config user.name ${GITLAB_USER_ID}
        git config user.email ${GITLAB_USER_EMAIL}
        git fetch --all
        git checkout dev
        git reset --hard origin/dev
        git merge "origin/"${CI_COMMIT_REF_NAME} --no-commit --no-ff
        export EXTRA_BRANCH="dev"
      else
        export EXTRA_BRANCH="${CI_COMMIT_REF_NAME}"
      fi

build:debug-linux:
  <<: *linux_job
  stage: build
  dependencies: []
  script:
    # Build the project on the merge result.
    - mkdir -p $CI_PROJECT_DIR/archive
    - rm -rf $CI_PROJECT_DIR/archive/* $CI_PROJECT_DIR/build/* $CI_PROJECT_DIR/install/*
    - cd $CI_PROJECT_DIR/build/
    - ccache -s
    # PCH are disabled because they don't work with ccache.
    - >
      cmake $CI_PROJECT_DIR
      -G Ninja
      -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/install
      -DCMAKE_BUILD_TYPE=Debug
    - find . -type f -iname '*.?pp' -exec touch -t 197001010000 {} \;
    - ninja
    # Install and build the package
    - ninja install
    - ninja package
    - ccache -s
    # Retrieve package name and store it as environment files since inherited environment variable is experimental
    # and need to explicitly enabled (https://docs.gitlab.com/ee/ci/variables/#enable-inherited-environment-variables-core-only)
    - export ARCHIVE_FILE_PATH=$(find $CI_PROJECT_DIR/build -maxdepth 1 -iname '*.tar.gz' -type f -print -quit)
    - export ARCHIVE_NAME=$(basename -s .tar.gz ${ARCHIVE_FILE_PATH})
    - mv ${ARCHIVE_FILE_PATH} $CI_PROJECT_DIR/archive/archive.tar.gz
    - echo "export ARCHIVE_NAME=${ARCHIVE_NAME}" > $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
    - cat $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SDK"
    paths:
      - $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
      - $CI_PROJECT_DIR/archive/archive.tar.gz
    when: always

build:release-linux:
  <<: *linux_job
  stage: build
  dependencies: []
  script:
    # Build the project on the merge result.
    - mkdir -p $CI_PROJECT_DIR/archive
    - rm -rf $CI_PROJECT_DIR/archive/* $CI_PROJECT_DIR/build/* $CI_PROJECT_DIR/install/*
    - cd $CI_PROJECT_DIR/build/
    - ccache -s
    # PCH are disabled because they don't work with ccache.
    - >
      cmake $CI_PROJECT_DIR
      -G Ninja
      -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/install
      -DCMAKE_BUILD_TYPE=Release
      -DBUILD_TESTS=ON
      -DBUILD_DOCUMENTATION=OFF
      -DENABLE_PCH=OFF
      -DBUILD_SDK=ON
      -DSPYLOG_LEVEL=error
    - find . -type f -iname '*.?pp' -exec touch -t 197001010000 {} \;
    - ninja
    # Install and build the package
    - ninja install
    - ninja package
    - ccache -s
    # Retrieve package name and store it as environment files since inherited environment variable is experimental
    # and need to explicitly enabled (https://docs.gitlab.com/ee/ci/variables/#enable-inherited-environment-variables-core-only)
    - export ARCHIVE_FILE_PATH=$(find $CI_PROJECT_DIR/build -maxdepth 1 -iname '*.tar.gz' -type f -print -quit)
    - export ARCHIVE_NAME=$(basename -s .tar.gz ${ARCHIVE_FILE_PATH})
    - mv ${ARCHIVE_FILE_PATH} $CI_PROJECT_DIR/archive/archive.tar.gz
    - echo "export ARCHIVE_NAME=${ARCHIVE_NAME}" > $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
    - cat $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SDK"
    paths:
      - $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
      - $CI_PROJECT_DIR/archive/archive.tar.gz
    when: always

deploy:debug-linux:
  <<: *linux_job
  stage: deploy
  when: manual
  script:
    - source $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
    - >
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "dev" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        export ARTIFACTORY_NAME=${ARCHIVE_NAME}
      else
        export ARTIFACTORY_NAME="sight-deps-Debug-latest-$CI_COMMIT_REF_NAME-Linux"
      fi
    - curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/archive.tar.gz "https://conan.ircad.fr/artifactory/data/sight-deps/${ARTIFACTORY_NAME}"
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SDK"
    paths:
      - $CI_PROJECT_DIR/archive/archive.tar.gz

deploy:release-linux:
  <<: *linux_job
  stage: deploy
  when: manual
  script:
    - source $CI_PROJECT_DIR/archive/ARCHIVE_NAME.env
    - >
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "dev" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        export ARTIFACTORY_NAME=${ARCHIVE_NAME}
      else
        export ARTIFACTORY_NAME="sight-deps-Release-latest-$CI_COMMIT_REF_NAME-Linux"
      fi
    - curl -u${CONAN_USERNAME}:${CONAN_PASSWORD} -T $CI_PROJECT_DIR/archive/archive.tar.gz "https://conan.ircad.fr/artifactory/data/sight-deps/${ARTIFACTORY_NAME}"
  artifacts:
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}-SDK"
    paths:
      - $CI_PROJECT_DIR/archive/archive.tar.gz
